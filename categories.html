<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpenRecovery by Category</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #F4FBFA 0%, #E8F5F3 100%);
      margin: 0;
      padding: 20px;
      color: #2C5F5D;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      text-align: center;
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      border: 2px solid rgba(95, 189, 173, 0.2);
    }
    .header h1 { margin: 0; font-size: 2.3rem; color: #5FBDAD; }
    .header p { margin: 10px 0 0; color: #666; }

    .nav-bar {
      display: flex; gap: 10px; justify-content: center;
      margin-bottom: 20px; flex-wrap: wrap;
    }
    .nav-link {
      background: white;
      padding: 12px 20px;
      border-radius: 10px;
      text-decoration: none;
      color: #2C5F5D;
      border: 2px solid rgba(95, 189, 173, 0.2);
      font-weight: 700;
      transition: all 0.2s ease;
    }
    .nav-link:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(95, 189, 173, 0.2); }
    .nav-link.active { background: #5FBDAD; color: white; border-color: #5FBDAD; }

    .search-section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .search-input {
      width: 100%; padding: 15px; border: 2px solid #E8F5F3;
      border-radius: 10px; font-size: 1.1rem; outline: none;
      transition: border-color 0.2s ease;
    }
    .search-input:focus { border-color: #5FBDAD; }

    .main-content { display: grid; gap: 20px; }
    .category-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      border: 2px solid rgba(95, 189, 173, 0.12);
    }
    .category-header { display:flex; justify-content:space-between; align-items:center; gap: 12px; flex-wrap: wrap; }
    .category-name { margin: 0; font-size: 1.5rem; color: #2C5F5D; }
    .company-count { background:#E8F5F3; border:1px solid rgba(95, 189, 173, 0.25); border-radius:999px; padding: 6px 12px; font-weight:700; font-size: 0.9rem; }

    .solutions-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    .solutions-table th {
      background: linear-gradient(135deg, #5FBDAD 0%, #3B9B8C 100%);
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 700;
      font-size: 0.95rem;
    }
    .solutions-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: top;
    }
    .solutions-table tr:last-child td { border-bottom: none; }
    .solutions-table tr:hover { background: #E8F5F3; }
    .problem-cell { color: #2C5F5D; font-weight: 700; }
    .solution-cell { color: #555; }
    .feature-cell { color: #3B9B8C; font-weight: 700; }

    .companies-list { margin-top: 18px; display: flex; flex-wrap: wrap; gap: 8px; }
    .company-link {
      background: #E8F5F3;
      color: #2C5F5D;
      padding: 6px 10px;
      border-radius: 999px;
      text-decoration: none;
      font-size: 0.80rem; /* smaller, per your request */
      border: 1px solid rgba(95, 189, 173, 0.25);
      font-weight: 700;
    }
    .company-link:hover { background: #5FBDAD; color: white; }

    .btn-primary {
      background: linear-gradient(135deg, #5FBDAD 0%, #3B9B8C 100%);
      color: white;
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 14px;
    }

    .loading { text-align:center; padding: 40px; font-size: 1.2rem; color: #666; }
    .error { background: #fff0f0; border: 1px solid #ffb3b3; color: #a30000; padding: 16px; border-radius: 12px; }

    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 92%; max-width: 900px; max-height: 80vh; overflow-y: auto; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: #5FBDAD; }
    .email-preview { background: #E8F5F3; padding: 20px; border-radius: 10px; margin: 16px 0; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; white-space: pre-wrap; border: 2px solid #7FD4C6; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>üè¢ Categories & Attendees</h1>
      <p>Browse by organization type or attendee persona</p>
    </header>

    <nav class="nav-bar">
      <a href="categories.html" class="nav-link active">üìÇ By Category</a>
      <a href="companies.html" class="nav-link">üìã All Companies</a>
    </nav>

    <div class="search-section">
      <input type="text" id="searchInput" placeholder="üîç Search categories‚Ä¶" class="search-input" />
    </div>

    <main id="mainContent" class="main-content">
      <div class="loading">‚è≥ Loading categories‚Ä¶</div>
    </main>

    <div id="emailModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2 style="color:#5FBDAD;margin:0 0 10px;">üìß Generated Email</h2>
        <div id="emailContent" class="email-preview"></div>
        <button class="btn-primary" id="copyBtn">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <script>
    const DATA_URL = () => `data.json?cb=${Date.now()}`; // cache-bust
    const ORG_TYPES = [
      {key: "iop", name: "IOP (Intensive Outpatient)"},
      {key: "php", name: "PHP (Partial Hospitalization)"},
      {key: "residential", name: "Residential Treatment"},
      {key: "detox", name: "Detox Facilities"},
      {key: "mat", name: "MAT Programs"},
      {key: "outpatient", name: "Outpatient Counseling"},
      {key: "teen-adolescent", name: "Teen/Adolescent Programs"},
      {key: "telehealth", name: "Telehealth Providers"},
      {key: "sober-living", name: "Sober Living Homes"},
      {key: "long-term", name: "Long-Term Care"},
      {key: "dual-diagnosis", name: "Dual Diagnosis"}
    ];

    let COMPANIES = [];
    let CATEGORIES = {};

    const $ = (id) => document.getElementById(id);

    function slugify(x) {
      return (x || "").toString().trim().toLowerCase()
        .replace(/&/g, "and")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    async function loadData() {
      const res = await fetch(DATA_URL(), { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load data.json (${res.status})`);
      const data = await res.json();
      COMPANIES = Array.isArray(data.companies) ? data.companies : [];
      buildCategories();
    }

    function buildCategories() {
      CATEGORIES = {};

      ORG_TYPES.forEach(orgType => {
        const companies = COMPANIES.filter(c =>
          (c.org_types || []).some(t => {
            const s = slugify(t);
            return s === orgType.key || s.includes(orgType.key) || slugify(orgType.name) === s;
          })
        );

        if (!companies.length) return;

        // Aggregate top problems (and keep solution/feature)
        const agg = new Map(); // problem -> {problem, solution, feature, count}
        companies.forEach(company => {
          (company.solutions || []).forEach(sol => {
            const p = (sol.problem || "").trim();
            if (!p) return;
            const existing = agg.get(p);
            if (!existing) {
              agg.set(p, { problem: p, solution: sol.solution || "", feature: sol.feature || "", count: 1 });
            } else {
              existing.count += 1;
            }
          });
        });

        const solutions = [...agg.values()]
          .sort((a,b) => b.count - a.count)
          .slice(0, 8);

        CATEGORIES[orgType.key] = {
          key: orgType.key,
          name: orgType.name,
          companies,
          solutions
        };
      });
    }

    function buildCategoryEmail(category) {
      const top = (category.solutions || []).slice(0, 4);
      const bullets = top.map(s => `‚Ä¢ ${s.problem} ‚Üí ${s.solution} (OpenRecovery: ${s.feature})`).join("\n");
      const sampleCompanies = (category.companies || []).slice(0, 8).map(c => `- ${c.name}`).join("\n");

      return [
        `Subject: OpenRecovery for ${category.name} ‚Äî a few common pain points we solve`,
        ``,
        `Hi there,`,
        ``,
        `I‚Äôm reaching out because we work with ${category.name} programs on a few recurring challenges:`,
        bullets || `‚Ä¢ (Add problems/solutions/features in the sheet to populate this list)`,
        ``,
        `OpenRecovery pairs a member mobile app (Kai AI) with a facilitator dashboard (RecoveryIQ) so staff can support engagement between sessions, handle after-hours needs, and track progress without extra admin burden.`,
        ``,
        `If helpful, here are a few example organizations we‚Äôre tracking in this space:`,
        sampleCompanies || `- (No companies found)`,
        ``,
        `Would a short demo be useful?`,
        ``,
        `Best,`,
        `Isaac`,
      ].join("\n");
    }

    function openModal(text) {
      $("emailContent").textContent = text;
      $("emailModal").style.display = "block";
    }
    function closeModal() {
      $("emailModal").style.display = "none";
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function escapeAttr(str) { return escapeHtml(str).replaceAll("`", "&#096;"); }

    function renderAll(searchTerm = "") {
      const term = (searchTerm || "").trim().toLowerCase();
      const container = $("mainContent");

      const categories = Object.values(CATEGORIES)
        .filter(cat => !term || cat.name.toLowerCase().includes(term) || cat.key.includes(term))
        .sort((a,b) => (b.companies?.length || 0) - (a.companies?.length || 0));

      if (!categories.length) {
        container.innerHTML = `<div class="category-card"><p style="margin:0;color:#666;">No categories found.</p></div>`;
        return;
      }

      container.innerHTML = categories.map(cat => {
        const rows = (cat.solutions || []).map(s => `
          <tr>
            <td class="problem-cell">${escapeHtml(s.problem)}</td>
            <td class="solution-cell">${escapeHtml(s.solution)}</td>
            <td class="feature-cell">${escapeHtml(s.feature)}</td>
          </tr>
        `).join("");

        const table = (cat.solutions || []).length ? `
          <table class="solutions-table">
            <thead>
              <tr>
                <th style="width:30%;">Problem</th>
                <th style="width:35%;">Solution</th>
                <th style="width:35%;">OpenRecovery Feature</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        ` : `<p style="color:#999;font-style:italic;margin:14px 0 0;">No problems/solutions yet for this category.</p>`;

        const companies = (cat.companies || []).map(c =>
          `<a class="company-link" href="companies.html?company=${escapeAttr(c.id || "")}">${escapeHtml(c.name || "")}</a>`
        ).join("");

        const anchorId = `category-${cat.key}`;

        return `
          <section class="category-card" id="${anchorId}">
            <div class="category-header">
              <h2 class="category-name">${escapeHtml(cat.name)}</h2>
              <span class="company-count">${cat.companies.length} Companies</span>
            </div>

            ${table}

            <div class="companies-list">
              ${companies}
            </div>

            <button class="btn-primary" data-action="email" data-category="${escapeAttr(cat.key)}">Generate Email</button>
          </section>
        `;
      }).join("");

      // wire up buttons
      container.querySelectorAll('[data-action="email"]').forEach(btn => {
        btn.addEventListener("click", () => {
          const key = btn.getAttribute("data-category");
          const cat = CATEGORIES[key];
          if (!cat) return;
          openModal(buildCategoryEmail(cat));
        });
      });
    }

    (async function init() {
      try {
        await loadData();
        renderAll("");

        $("searchInput").addEventListener("input", (e) => renderAll(e.target.value));

        $("closeModal").addEventListener("click", closeModal);
        window.addEventListener("click", (e) => { if (e.target === $("emailModal")) closeModal(); });

        $("copyBtn").addEventListener("click", async () => {
          const text = $("emailContent").textContent || "";
          await navigator.clipboard.writeText(text);
          $("copyBtn").textContent = "Copied!";
          setTimeout(() => ($("copyBtn").textContent = "Copy to Clipboard"), 900);
        });
      } catch (err) {
        console.error(err);
        $("mainContent").innerHTML = `<div class="error"><strong>Error:</strong> ${escapeHtml(err.message || String(err))}</div>`;
      }
    })();
  </script>
</body>
</html>

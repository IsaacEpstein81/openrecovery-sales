<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpenRecovery Sales Intelligence</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #F4FBFA 0%, #E8F5F3 100%);
      margin: 0;
      padding: 20px;
      color: #2C5F5D;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      text-align: center;
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      border: 2px solid rgba(95, 189, 173, 0.2);
    }
    .header h1 { margin: 0; font-size: 2.4rem; color: #5FBDAD; }
    .subtitle { color: #666; margin: 10px 0 0; font-size: 1.1rem; }

    .nav-bar {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .nav-link {
      background: white;
      padding: 12px 20px;
      border-radius: 10px;
      text-decoration: none;
      color: #2C5F5D;
      border: 2px solid rgba(95, 189, 173, 0.2);
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .nav-link:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(95, 189, 173, 0.2); }
    .nav-link.active { background: #5FBDAD; color: white; border-color: #5FBDAD; }

    .search-section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .search-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #E8F5F3;
      border-radius: 10px;
      font-size: 1.1rem;
      outline: none;
      transition: border-color 0.2s ease;
    }
    .search-input:focus { border-color: #5FBDAD; }

    .main-content { display: grid; gap: 20px; }
    .company-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      border: 2px solid rgba(95, 189, 173, 0.12);
      transition: all 0.2s ease;
    }
    .company-card:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(0,0,0,0.10); }
    .company-card.focused { border-color: #5FBDAD; box-shadow: 0 0 0 4px rgba(95,189,173,0.20), 0 15px 35px rgba(0,0,0,0.10); }

    .company-name { margin: 0 0 12px; font-size: 1.5rem; color: #2C5F5D; }
    .type-badge {
      display: inline-block;
      background: #E8F5F3;
      color: #2C5F5D;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      margin: 0 6px 6px 0;
      text-decoration: none;
      border: 1px solid rgba(95, 189, 173, 0.25);
      font-weight: 600;
    }
    .type-badge:hover { background: #5FBDAD; color: white; }

    .meta { margin: 10px 0; color: #444; }
    .meta a { color: #3B9B8C; text-decoration: none; font-size: 0.95rem; }
    .meta a:hover { text-decoration: underline; }

    .solutions-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    .solutions-table th {
      background: linear-gradient(135deg, #5FBDAD 0%, #3B9B8C 100%);
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 700;
      font-size: 0.95rem;
    }
    .solutions-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: top;
    }
    .solutions-table tr:last-child td { border-bottom: none; }
    .solutions-table tr:hover { background: #E8F5F3; }
    .problem-cell { color: #2C5F5D; font-weight: 600; }
    .solution-cell { color: #555; }
    .feature-cell { color: #3B9B8C; font-weight: 700; }

    .btn-primary {
      background: linear-gradient(135deg, #5FBDAD 0%, #3B9B8C 100%);
      color: white;
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 14px;
    }
    .btn-primary:hover { filter: brightness(1.03); }

    .loading { text-align: center; padding: 40px; font-size: 1.2rem; color: #666; }
    .error { background: #fff0f0; border: 1px solid #ffb3b3; color: #a30000; padding: 16px; border-radius: 12px; }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 15px;
      width: 92%;
      max-width: 900px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: #5FBDAD; }
    .email-preview {
      background: #E8F5F3;
      padding: 20px;
      border-radius: 10px;
      margin: 16px 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre-wrap;
      border: 2px solid #7FD4C6;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>üéØ OpenRecovery Sales Intelligence</h1>
      <p class="subtitle" id="companyCount">Loading companies‚Ä¶</p>
    </header>

    <nav class="nav-bar">
      <a href="categories.html" class="nav-link">üìÇ By Category</a>
      <a href="companies.html" class="nav-link active">üìã All Companies</a>
    </nav>

    <div class="search-section">
      <input type="text" id="searchInput" placeholder="üîç Search companies‚Ä¶" class="search-input" />
    </div>

    <main id="mainContent" class="main-content">
      <div class="loading">‚è≥ Loading companies‚Ä¶</div>
    </main>

    <div id="emailModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2 style="color:#5FBDAD;margin:0 0 10px;">üìß Generated Email</h2>
        <div id="emailContent" class="email-preview"></div>
        <button id="copyEmail" class="btn-primary">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <script>
    const DATA_URL = () => `data.json?cb=${Date.now()}`; // cache-bust GitHub Pages

    let COMPANIES = [];

    const $ = (id) => document.getElementById(id);

    function slugify(x) {
      return (x || "").toString().trim().toLowerCase()
        .replace(/&/g, "and")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    async function loadData() {
      const res = await fetch(DATA_URL(), { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load data.json (${res.status})`);
      const data = await res.json();
      COMPANIES = Array.isArray(data.companies) ? data.companies : [];
      return COMPANIES;
    }

    function uniqueProblems(company) {
      const set = new Set((company.solutions || []).map(s => (s.problem || "").trim()).filter(Boolean));
      return [...set];
    }

    function buildEmail(company) {
      const problems = uniqueProblems(company).slice(0, 3);
      const solutions = (company.solutions || []).slice(0, 3);

      const topLine = problems[0] ? `re: ${problems[0]}` : "quick idea for your team";
      const bullets = solutions.map(s => `‚Ä¢ ${s.problem} ‚Üí ${s.solution} (OpenRecovery: ${s.feature})`).join("\n");

      return [
        `Subject: OpenRecovery idea for ${company.name} ‚Äî ${topLine}`,
        ``,
        `Hi ${company.name} team,`,
        ``,
        `I‚Äôm reaching out because we work with programs like yours on a few recurring challenges:`,
        bullets ? bullets : `‚Ä¢ (Add problems/solutions in the sheet to generate bullets here)`,
        ``,
        `OpenRecovery pairs a member mobile app (Kai AI) with a facilitator dashboard (RecoveryIQ) to help staff stay ahead of engagement risk, follow-through, and after-hours support.`,
        ``,
        `If it‚Äôs helpful, I can share a 5-minute demo tailored to ${company.org_types?.[0] || "your care model"} and your population (${company.target || "your audience"}).`,
        ``,
        `Best,`,
        `Isaac`,
      ].join("\n");
    }

    function openModal(text) {
      $("emailContent").textContent = text;
      $("emailModal").style.display = "block";
    }

    function closeModal() {
      $("emailModal").style.display = "none";
    }

    function renderCompanies(searchTerm = "") {
      const term = (searchTerm || "").trim().toLowerCase();
      const container = $("mainContent");

      const filtered = COMPANIES.filter(c =>
        !term ||
        (c.name || "").toLowerCase().includes(term) ||
        (c.location || "").toLowerCase().includes(term) ||
        (c.target || "").toLowerCase().includes(term) ||
        (c.org_types || []).some(t => (t || "").toLowerCase().includes(term))
      );

      if (!filtered.length) {
        container.innerHTML = `<div class="company-card"><p style="margin:0;color:#666;">No companies found.</p></div>`;
        return;
      }

      container.innerHTML = filtered.map(company => {
        const rows = (company.solutions || []).map(s => `
          <tr>
            <td class="problem-cell">${escapeHtml(s.problem || "")}</td>
            <td class="solution-cell">${escapeHtml(s.solution || "")}</td>
            <td class="feature-cell">${escapeHtml(s.feature || "")}</td>
          </tr>
        `).join("");

        const table = (company.solutions || []).length ? `
          <table class="solutions-table">
            <thead>
              <tr>
                <th style="width:30%;">Problem</th>
                <th style="width:35%;">Solution</th>
                <th style="width:35%;">OpenRecovery Feature</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        ` : `<p style="color:#999;font-style:italic;margin:14px 0 0;">No problems/solutions yet for this company.</p>`;

        const badges = (company.org_types || []).map(t => {
          const catId = slugify(t);
          return `<a class="type-badge" href="categories.html#category-${catId}">${escapeHtml(t)}</a>`;
        }).join("");

        const safeWebsite = company.website || "";
        const websiteLink = safeWebsite ? `<a href="${escapeAttr(safeWebsite)}" target="_blank" rel="noreferrer">${escapeHtml(safeWebsite)}</a>` : "";

        return `
          <section class="company-card" id="company-${escapeAttr(company.id || "")}">
            <h2 class="company-name">${escapeHtml(company.name || "")}</h2>
            <div>${badges}</div>
            ${company.location ? `<div class="meta"><strong>üìç</strong> ${escapeHtml(company.location)}</div>` : ""}
            ${company.target ? `<div class="meta"><strong>üë•</strong> ${escapeHtml(company.target)}</div>` : ""}
            ${websiteLink ? `<div class="meta"><strong>üåê</strong> ${websiteLink}</div>` : ""}
            ${table}
            <button class="btn-primary" data-action="email" data-company="${escapeAttr(company.id || "")}">Generate Email</button>
          </section>
        `;
      }).join("");

      // wire up buttons
      container.querySelectorAll('[data-action="email"]').forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-company");
          const company = COMPANIES.find(c => String(c.id) === String(id));
          if (!company) return;
          openModal(buildEmail(company));
        });
      });
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function escapeAttr(str) { return escapeHtml(str).replaceAll("`", "&#096;"); }

    function focusFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("company");
      if (!id) return;

      const el = document.getElementById(`company-${id}`);
      if (!el) return;

      el.classList.add("focused");
      el.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // init
    (async function init() {
      try {
        await loadData();
        $("companyCount").textContent = `${COMPANIES.length} Companies ‚Ä¢ Generate personalized emails`;
        renderCompanies("");
        focusFromQuery();

        $("searchInput").addEventListener("input", (e) => renderCompanies(e.target.value));

        $("closeModal").addEventListener("click", closeModal);
        window.addEventListener("click", (e) => { if (e.target === $("emailModal")) closeModal(); });

        $("copyEmail").addEventListener("click", async () => {
          const text = $("emailContent").textContent || "";
          await navigator.clipboard.writeText(text);
          $("copyEmail").textContent = "Copied!";
          setTimeout(() => ($("copyEmail").textContent = "Copy to Clipboard"), 900);
        });
      } catch (err) {
        console.error(err);
        $("mainContent").innerHTML = `<div class="error"><strong>Error:</strong> ${escapeHtml(err.message || String(err))}</div>`;
        $("companyCount").textContent = "Error loading companies";
      }
    })();
  </script>
</body>
</html>
